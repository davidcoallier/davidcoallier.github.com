
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link type="text/css" rel="stylesheet" href="style.css"/>
    <link type="text/css" rel="stylesheet" href="table.css"/>

    <style type="text/css">

path.arc {
  cursor: move;
  fill: #fff;
}

.node {
  color: #f5f5f5;
  color: #c4c4c4;
  color: #9e9e9e;
  font-size: 10px;
  fill: #c4c4c4;
  fill: #9e9e9e;
  cursor: pointer;
}

.node:hover {
  fill: #1f77b4;
  text-decoration: bold !important;
  font-size: 15px;
}

.link {
  fill: none;
  stroke: #1f77b4;
  stroke: #c4c4c4;
  stroke: #9e9e9e;
  stroke-opacity: .1;
  pointer-events: none;
}

.link.source, .link.target {
  stroke-opacity: 1;
  stroke-width: 1px;
  stroke: black;
}

.node.target {
  fill: #d62728 !important;
  fill: #1f77b4 !important;
  font-size: 13px !important;
}

.link.source {
  stroke: #d62728;
  stroke: #1f77b4;
}

.node.source {
  fill: #2ca02c;
}

.link.target {
  stroke: #2ca02c;
  stroke: #1f77b4;
}

    </style>
  </head>
  <body> 
    <h2>Industry Investors</h2>
    <h3>A list of non-instutional investors, by industry</h3>
    <br />
    <div class="group" id="web">
      <h2>Web Investors</h2>
      <div class="chart"></div>
      <div class="table">
      </div>
    </div>

    <div class="group" id="mobile">
      <h2>Mobile Investor</h2>
      <div class="chart"></div>
      <div class="table">
      </div>
    </div>

    <div class="group" id="biotech">
      <h2>Biotech Investor</h2>
      <div class="chart"></div>
      <div class="table">
      </div>
    </div>

    <div class="group" id="security">
      <h2>Security Investor</h2>
      <div class="chart"></div>
      <div class="table">
      </div>
    </div>

    <script type="text/javascript" src="d3/d3.js"></script>
    <script type="text/javascript" src="d3/d3.layout.js"></script>
    <script type="text/javascript" src="d3/packages.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript">

      function drawGraph(divName) {
        var w = 700,
            h = 550,
            rx = w / 2,
            ry = h / 2,
            m0,
            rotate = 0;

        var splines = [];

        var cluster = d3.layout.cluster()
          .size([360, ry - 90])
          .sort(function(a, b) { return d3.ascending(a.key, b.key); });

        var bundle = d3.layout.bundle();

        var line = d3.svg.line.radial()
          .interpolate("bundle")
          .tension(.85)
          .radius(function(d) { return d.y; })
          .angle(function(d) { return d.x / 180 * Math.PI; });

        // Chrome 15 bug: <http://code.google.com/p/chromium/issues/detail?id=98951>
        var div = d3.select("#" + divName + ' .chart')
          .style("width", w + "px")
          .style("height", w + "px")
          //.style("position", "absolute")
          .style("-webkit-backface-visibility", "hidden");

        var svg = div.append("svg:svg")
          .attr("width", w)
          .attr("height", w)
          .append("svg:g")
          .attr("transform", "translate(" + rx + "," + ry + ")");

        svg.append("svg:path")
          .attr("class", "arc")
          .attr("d", d3.svg.arc().outerRadius(ry - 120).innerRadius(0).startAngle(0).endAngle(2 * Math.PI))
          .on("mousedown", mousedown);

        d3.json("data/person/"+divName+"-graph.json", function(classes) {
            var nodes = cluster.nodes(packages.root(classes)),
            links = packages.imports(nodes),
            splines = bundle(links);


            var path = svg.selectAll("path.link")
            .data(links)
            .enter().append("svg:path")
            .attr("class", function(d) { return "link source-" + d.source.key + " target-" + d.target.key; })
            .attr("d", function(d, i) { return line(splines[i]); });

            svg.selectAll("g.node")
            .data(nodes.filter(function(n) { return !n.children; }))
            .enter().append("svg:g")
            .attr("class", "node")
            .attr("id", function(d) { return "node-" + d.key; })
            .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })
            .append("svg:text")
            .attr("dx", function(d) { return d.x < 180 ? 8 : -8; })
            //.attr("dy", ".31em")
            .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
            .attr("transform", function(d) { return d.x < 180 ? null : "rotate(180)"; })
            .text(function(d) { return d.key.replace('-', ' '); })
            .on("mouseover", mouseover)
            .on("mouseout", mouseout);

        d3.select("input[type=range]").on("change", function() {
            line.tension(this.value / 100);
            path.attr("d", function(d, i) { return line(splines[i]); });
            });
        });

        d3.select(window)
          .on("mousemove", this.mousemove)
          .on("mouseup", mouseup);

        function mouse(e) {
          return [e.pageX - rx, e.pageY - ry];
        }

        function mousedown() {
          m0 = mouse(d3.event);
          d3.event.preventDefault();
        }

        function mousemove() {
          if (m0) {
            var m1 = mouse(d3.event),
                dm = Math.atan2(cross(m0, m1), dot(m0, m1)) * 180 / Math.PI;
            div.style("-webkit-transform", "translateY(" + (ry - rx) + "px)rotateZ(" + dm + "deg)translateY(" + (rx - ry) + "px)");
          }
        }

        function mouseup() {
          if (m0) {
            var m1 = mouse(d3.event),
                dm = Math.atan2(cross(m0, m1), dot(m0, m1)) * 180 / Math.PI;

            rotate += dm;
            if (rotate > 360) rotate -= 360;
            else if (rotate < 0) rotate += 360;
            m0 = null;

            div.style("-webkit-transform", null);

            svg
              .attr("transform", "translate(" + rx + "," + ry + ")rotate(" + rotate + ")")
              .selectAll("g.node text")
              .attr("dx", function(d) { return (d.x + rotate) % 360 < 180 ? 8 : -8; })
              .attr("text-anchor", function(d) { return (d.x + rotate) % 360 < 180 ? "start" : "end"; })
              .attr("transform", function(d) { return (d.x + rotate) % 360 < 180 ? null : "rotate(180)"; });
          }
        }

        function mouseover(d) {
          svg.selectAll("path.link.target-" + d.key)
            .classed("target", true)
            .each(updateNodes("source", true));

          svg.selectAll("path.link.source-" + d.key)
            .classed("source", true)
            .each(updateNodes("target", true));
        }

        function mouseout(d) {
          svg.selectAll("path.link.source-" + d.key)
            .classed("source", false)
            .each(updateNodes("target", false));

          svg.selectAll("path.link.target-" + d.key)
            .classed("target", false)
            .each(updateNodes("source", false));
        }

        function updateNodes(name, value) {
          return function(d) {
            if (value) this.parentNode.appendChild(this);
            svg.select("#node-" + d[name].key).classed(name, value);
          };
        }

        function cross(a, b) {
          return a[0] * b[1] - a[1] * b[0];
        }

        function dot(a, b) {
          return a[0] * b[0] + a[1] * b[1];
        }
      }

      function drawTable(divName) {
        
        table = $("<table cellspacing='0'></table>");
        head  = $("<tr><th>Investor Name</th><th>Number of Connections</th><th>Bridge Maker Ranking</th><th>Influence Ranking</th></tr>");
        table.append(head);

        var users = {}
        $.ajax({
          url: 'data/person/'+divName+'-centrality.json', 
          dataType: 'json',
          async:false, 
          success: function(d) {
            var centrality = d.betweenness;
            for (var k in centrality) {
              users[centrality[k][0]] = {
                'betweenness': centrality[k][1]
              }
            }
          }
        });
        console.log(users)

        $.ajax({
          url: 'data/person/'+divName+'-graph.json', 
          dataType: 'json',
          async: false, 
          success: function(d) {
            for (var entry in d) {
              investor = d[entry]
              if (typeof(users[investor.name]) == 'undefined') {
                users[investor.name] = {}
              }
              users[investor.name]['investments'] = investor.imports.length;
            }
          }
        });

        var i = 0;
        for (var user in users) {
          row  = $("<tr><td>"+user.replace('-', ' ')+"</td><td>"+users[user]['investments']+"</td><td>"+users[user]['betweenness']+"</td><td>3</td></tr>");
          table.append(row)
          i += 1;
        }

        $('#' + divName + ' > .table').append(table);
      }

      drawGraph('web');
      drawTable('web')
      drawGraph('mobile');
      drawTable('mobile');
      drawGraph('biotech');
      drawGraph('legal');
      drawGraph('security');
    </script>
  </body>
</html>

